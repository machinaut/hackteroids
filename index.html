<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN""http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <head>
    <title>HACKTEROIDS!</title>
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript" src="Soft03CritList.js"></script>
    <script type="text/javascript">
        var ge;
        var loopTimer;
        google.load("earth", "1", {"other_params":"sensor=true"});
        console.log("Num Asteroids loaded:",data.length);

        function loopTime() { // sets the current slider position to the current system time
            var speedyRate = 6*60*24*365; // 1 year for each 10 seconds
            var time = ge.getTime().getTimePrimitive();
            if (time.getType() == 'KmlTimeSpan') {
                console.log("Time Span: ",time.getEnd().get());
                if(time.getEnd().get() >= '2015') {
                    time.getEnd().set('2001');
                    ge.getTime().setRate(speedyRate);
                }
            } else {
                console.log("Time Stamp: ",time.getWhen().get());
                if(time.getWhen().get() >= '2015') {
                    time.getWhen().set('2001');
                    ge.getTime().setRate(speedyRate);
                }
            }
        }

        function init() {
            google.earth.createInstance('map3d', initCB, failureCB);
        }

        function initCB(instance) {
            ge = instance;

            // Hack to really show control slider
            //ge.getTime().setHistoricalImageryEnabled(true);
            //ge.getTime().setHistoricalImageryEnabled(false);
            //ge.getTime().setRate(0); // pause
            // Show time control slider
            ge.getTime().getControl().setVisibility(ge.VISIBILITY_SHOW);

            animThing(0.5, 0, 0, 0.4, 0.3, 2005, 2015);

            // Draw and show the earth
            ge.getWindow().setVisibility(true);

            // Set loop timer HACK NOT DOING THIS FOR RIGHT NOW
            //var loopTimer = setInterval(loopTime, 5000); //update the slider every 5 seconds
        }

        function failureCB(errorCode) {
        }

        // Draw a traveling thing (TODO: query per date.  This is a hack)
        function animThing(radius, lat, lon, vlat, vlon, begin, end) {
            for (var i = begin; i < end; i++) { // hack, need integer begin/end
                var j = i + 1; // end one year after start for now
                var pc = polyThing(radius, lat, lon, i.toString(), j.toString());
                ge.getFeatures().appendChild(pc);
                lat += vlat;
                lon += vlon;
            }
        }

        // Draw a thing on the map
        function polyThing(radius, lat, lon, begin, end) {
            var timeSpan = ge.createTimeSpan('');
            timeSpan.getBegin().set(begin);
            timeSpan.getEnd().set(end);

            var placemark = ge.createPlacemark('');
            placemark.setTimePrimitive(timeSpan);
            placemark.setGeometry(ge.createPolygon(''));

            var thing = makeThing(radius, lat, lon);
            placemark.getGeometry().setOuterBoundary(thing);

            return placemark;
        }

        function makeThing(radius, lat, lon) {
            var ring = ge.createLinearRing('');
            ring.getCoordinates().pushLatLngAlt(lat + radius, lon, 0);
            ring.getCoordinates().pushLatLngAlt(lat, lon + radius, 0);
            ring.getCoordinates().pushLatLngAlt(lat - radius, lon, 0);
            ring.getCoordinates().pushLatLngAlt(lat, lon - radius, 0);
            return ring;
        }

        // Start the show!
        google.setOnLoadCallback(init);
    </script>
  </head>
  <body>
    <div id="map3d" style="height: 400px; width: 600px;"></div>
  </body>
</html>
