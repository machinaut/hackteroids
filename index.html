<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN""http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <head>
    <title>HACKTEROIDS!</title>
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript">
        var ge;
        google.load("earth", "1", {"other_params":"sensor=true"});

        function init() {
            google.earth.createInstance('map3d', initCB, failureCB);
        }

        function initCB(instance) {
            ge = instance;

            // Hack to really show control slider
            //ge.getTime().setHistoricalImageryEnabled(true);
            //ge.getTime().setHistoricalImageryEnabled(false);
            // CONTROL TIME
            var speedyRate = 60*60*24*365; // 1 year for each real second.
            ge.getTime().setRate(speedyRate);
            ge.getTime().setRate(0); // pause
            // Set time span for control
            var timeSpan = ge.getTime().getTimePrimitive();
            console.log('timespan start ', timeSpan.getBegin().get());
            console.log('timespan stop ', timeSpan.getEnd().get());
            timeSpan.getEnd().set('2025-01-01');
            console.log('timespan newstop ', timeSpan.getEnd().get());
            ge.getTime().setTimePrimitive(timeSpan);
            // Show time control slider
            ge.getTime().getControl().setVisibility(ge.VISIBILITY_SHOW);

            // Make and draw a circle "polygon"
            var pc = polyCircle(0.65, 0, 0, '2001', '2014');
            ge.getFeatures().appendChild(pc);
            animCircle(0.5, 0, 0, 2, 3, 2001, 2050);

            // Draw and show the earth
            ge.getWindow().setVisibility(true);
        }

        function failureCB(errorCode) {
        }

        // Draw a traveling circle (TODO: query per date.  This is a hack)
        function animCircle(radius, lat, lon, vlat, vlon, begin, end) {
            for (var i = begin; i < end; i++) { // hack, need integer begin/end
                var j = i + 1; // end one year after start for now
                console.log('poly circle begin end ', i.toString(),
                        j.toString());
                var pc = polyCircle(radius, lat, lon, i.toString(), j.toString());
                ge.getFeatures().appendChild(pc);
                lat += vlat;
                lon += vlon;
            }
        }

        // Draw a circle on the map
        function polyCircle(radius, lat, lon, begin, end) {
            var timeSpan = ge.createTimeSpan('');
            timeSpan.getBegin().set(begin);
            timeSpan.getEnd().set(end);

            var placemark = ge.createPlacemark('');
            placemark.setTimePrimitive(timeSpan);
            placemark.setGeometry(ge.createPolygon(''));

            var circle = makeCircle(radius, lat, lon);
            placemark.getGeometry().setOuterBoundary(circle);

            return placemark;
        }

        // Make a circle (ring)
        function makeCircle(radius, lat, lon) {
            var ring = ge.createLinearRing('');
            var steps = 25;
            var pi2 = Math.PI * 2;
            for (var i = 0; i < steps; i++) {
                var x = lat + radius * Math.cos(i / steps * pi2);
                var y = lon + radius * Math.sin(i / steps * pi2);
                ring.getCoordinates().pushLatLngAlt(x, y, 0);
            }
            return ring;
        }

        // Start the show!
        google.setOnLoadCallback(init);
    </script>
  </head>
  <body>
    <div id="map3d" style="height: 400px; width: 600px;"></div>
  </body>
</html>
